#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f "$0")"
SCRIPT_ROOT="$(dirname "$(dirname "$(dirname "$SCRIPT_PATH")")")"

find_root() {
  local dir="$PWD"
  while [[ "$dir" != "/" ]]; do
    if [[ -d "$dir/.opencode/workflow" ]]; then
      echo "$dir"
      return 0
    fi
    dir=$(dirname "$dir")
  done
  if [[ -d "/.opencode/workflow" ]]; then
    echo "/"
    return 0
  fi
  return 1
}

ROOT="$(find_root 2>/dev/null || true)"
if [[ -z "$ROOT" ]]; then
  ROOT="$SCRIPT_ROOT"
fi

if [[ ! -d "$ROOT/.opencode/workflow" ]]; then
  echo "FAIL: workflow directory not found: $ROOT/.opencode/workflow"
  echo "Install opencode and run from project tree."
  exit 1
fi

WF="$ROOT/.opencode/workflow"
LOG="$WF/daemon.log"
PIDFILE="$WF/.daemon.pid"
SELFTEST=0

usage() {
  cat <<'EOF'
Usage: club <command> [options]

Commands:
  start [1]
  stop
  status
  logs [--follow]
  selftest
  ask "<text>"
  brainstorm [--quiet] [--tail N] [--no-context] [--preset NAME] "<text>"

Options:
  1           Run INFRA selftest before start
  --follow    Follow logs (tail -f)
  --quiet     Brainstorm: suppress transcript output
  --tail N    Brainstorm: print last N lines
  --no-context Brainstorm: ignore CONTEXT.md
  --preset NAME Brainstorm: override models from presets
  --no-color  Brainstorm: disable color output
EOF
}

require_tools() {
  local missing=0
  local tools=(bash flock timeout grep oc)
  for tool in "${tools[@]}"; do
    if ! command -v "$tool" >/dev/null 2>&1; then
      echo "FAIL: missing required tool: $tool"
      missing=1
    fi
  done
  if [[ $missing -ne 0 ]]; then
    exit 1
  fi
}

ensure_workflow() {
  if [[ ! -d "$WF" ]]; then
    echo "FAIL: workflow directory not found: $WF"
    exit 1
  fi
  mkdir -p "$WF"
  touch "$LOG"
}

ask_request() {
  ensure_workflow
  local text="$1"
  if [[ -z "$text" ]]; then
    echo "FAIL: ask requires text"
    exit 1
  fi
  local request_file="$WF/00_PM_REQUEST.md"
  local run_id_file="$WF/.selftest_run_id"
  local run_id
  run_id="$(date +%Y%m%d_%H%M%S)_${RANDOM}"
  echo "SELFTEST_RUN_ID=$run_id" > "$run_id_file"
  printf "# Chat Request\nrun_id=%s\nroot=%s\n\n%s\n" "$run_id" "$ROOT" "$text" > "$request_file"
  RUN_ID="$run_id" "$WF/pipeline.sh" >/dev/null 2>&1 &
  echo "OK: queued request run_id=$run_id"
}

brainstorm_request() {
  ensure_workflow
  local quiet=0
  local tail_lines=""
  local no_color=0
  local no_context=0
  local preset_name=""
  local text=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --quiet)
        quiet=1
        shift
        ;;
      --tail)
        if [[ -z "${2:-}" ]]; then
          echo "FAIL: --tail requires a number"
          exit 1
        fi
        if ! [[ "$2" =~ ^[0-9]+$ ]]; then
          echo "FAIL: --tail expects a number"
          exit 1
        fi
        tail_lines="$2"
        shift 2
        ;;
      --no-color)
        no_color=1
        shift
        ;;
      --no-context)
        no_context=1
        shift
        ;;
      --preset)
        if [[ -z "${2:-}" ]]; then
          echo "FAIL: --preset requires a name"
          exit 1
        fi
        if [[ "$2" == "list" ]]; then
          local preset_file="$ROOT/.opencode/config/models.presets.yml"
          if [[ ! -f "$preset_file" ]]; then
            echo "FAIL: presets file not found: $preset_file"
            exit 1
          fi
          local in_presets=0
          local line
          while IFS= read -r line; do
            if [[ "$line" =~ ^presets: ]]; then
              in_presets=1
              continue
            fi
            if [[ $in_presets -eq 1 && "$line" =~ ^[^[:space:]] ]]; then
              break
            fi
            if [[ $in_presets -eq 1 && "$line" =~ ^[[:space:]]{2}[A-Za-z0-9_-]+:[[:space:]]*$ ]]; then
              local preset_label
              preset_label="${line%%:*}"
              preset_label="${preset_label#${preset_label%%[![:space:]]*}}"
              local preset_model_b=""
              preset_model_b=$(sed -n "/^[[:space:]]*${preset_label}:[[:space:]]*$/,/^[[:space:]]{2}[A-Za-z0-9_-]+:/p" "$preset_file" | sed -n 's/^[[:space:]]*modelB:[[:space:]]*"\{0,1\}\(.*\)"\{0,1\}$/\1/p' | head -n 1)
              preset_model_b="${preset_model_b#${preset_model_b%%[![:space:]]*}}"
              preset_model_b="${preset_model_b%\"}"
              preset_model_b="${preset_model_b#\"}"
              if [[ -z "$preset_model_b" ]]; then
                echo "${preset_label} (single)"
              else
                echo "$preset_label"
              fi
            fi
          done < "$preset_file"
          exit 0
        fi
        preset_name="$2"
        shift 2
        ;;
      --*)
        echo "FAIL: unknown option $1"
        exit 1
        ;;
      *)
        text="${*:1}"
        break
        ;;
    esac
  done

  if [[ -z "$text" ]]; then
    echo "FAIL: brainstorm requires text"
    exit 1
  fi

  local session_id
  session_id="$(date +%Y%m%d_%H%M%S)_${RANDOM}"
  local session_dir="$WF/brainstorm/sessions/$session_id"
  mkdir -p "$session_dir"
  printf "# Brainstorm Prompt\nsession_id=%s\nroot=%s\n\n%s\n" "$session_id" "$ROOT" "$text" > "$session_dir/00_PROMPT.md"
  echo "[brainstorm] start session_id=$session_id root=$ROOT" >> "$LOG"

  local runner_args=("$session_id" "$session_dir" "$text")
  if [[ $quiet -eq 1 ]]; then
    runner_args+=("--quiet")
  fi
  if [[ -n "$tail_lines" ]]; then
    runner_args+=("--tail" "$tail_lines")
  fi
  if [[ $no_color -eq 1 ]]; then
    runner_args+=("--no-color")
  fi
  if [[ $no_context -eq 1 ]]; then
    runner_args+=("--no-context")
  fi

  local preset_file="$ROOT/.opencode/config/models.presets.yml"
  local preset_model_a=""
  local preset_model_b=""
  local preset_found=0
  if [[ -n "$preset_name" ]]; then
    if [[ ! -f "$preset_file" ]]; then
      echo "FAIL: presets file not found: $preset_file"
      exit 1
    fi

    local in_presets=0
    local in_target=0
    local raw_line
    while IFS= read -r raw_line; do
      if [[ "$raw_line" =~ ^presets: ]]; then
        in_presets=1
        continue
      fi
      if [[ $in_presets -eq 1 && "$raw_line" =~ ^[^[:space:]] ]]; then
        break
      fi
      if [[ $in_presets -eq 1 && "$raw_line" =~ ^[[:space:]]{2}${preset_name}:[[:space:]]*$ ]]; then
        in_target=1
        preset_found=1
        continue
      fi
      if [[ $in_target -eq 1 && "$raw_line" =~ ^[[:space:]]{2}[A-Za-z0-9_-]+: ]]; then
        break
      fi
      if [[ $in_target -eq 1 && "$raw_line" =~ ^[[:space:]]{4}modelA: ]]; then
        preset_model_a="${raw_line#*:}"
        preset_model_a="${preset_model_a#${preset_model_a%%[![:space:]]*}}"
        preset_model_a="${preset_model_a%\"}"
        preset_model_a="${preset_model_a#\"}"
      fi
      if [[ $in_target -eq 1 && "$raw_line" =~ ^[[:space:]]{4}modelB: ]]; then
        preset_model_b="${raw_line#*:}"
        preset_model_b="${preset_model_b#${preset_model_b%%[![:space:]]*}}"
        preset_model_b="${preset_model_b%\"}"
        preset_model_b="${preset_model_b#\"}"
      fi
    done < "$preset_file"

    if [[ $preset_found -eq 0 ]]; then
      echo "FAIL: preset not found: $preset_name"
      exit 1
    fi
    if [[ -z "$preset_model_a" ]]; then
      echo "FAIL: preset missing modelA: $preset_name"
      exit 1
    fi
  fi

  if [[ -n "$preset_name" ]]; then
    if BRAINSTORM_MODEL_A="$preset_model_a" BRAINSTORM_MODEL_B="$preset_model_b" BRAINSTORM_MODELS_SOURCE="preset:$preset_name" BRAINSTORM_PRESET_NAME="$preset_name" "$WF/brainstorm_runner.sh" "${runner_args[@]}"; then
      local meta_file="$session_dir/01_META.md"
      local model_a
      local model_b
      model_a=$(grep -E '^modelA=' "$meta_file" | head -n 1 | sed 's/^modelA=//')
      model_b=$(grep -E '^modelB=' "$meta_file" | head -n 1 | sed 's/^modelB=//')
      echo "OK: brainstorm session_id=$session_id modelA=$model_a modelB=$model_b"
      if [[ $quiet -eq 1 ]]; then
        echo "OK: transcript $session_dir/99_TRANSCRIPT.md"
      fi
    else
      echo "FAIL: brainstorm runner failed session_id=$session_id"
      exit 1
    fi
  else
    if "$WF/brainstorm_runner.sh" "${runner_args[@]}"; then
      local meta_file="$session_dir/01_META.md"
      local model_a
      local model_b
      model_a=$(grep -E '^modelA=' "$meta_file" | head -n 1 | sed 's/^modelA=//')
      model_b=$(grep -E '^modelB=' "$meta_file" | head -n 1 | sed 's/^modelB=//')
      echo "OK: brainstorm session_id=$session_id modelA=$model_a modelB=$model_b"
      if [[ $quiet -eq 1 ]]; then
        echo "OK: transcript $session_dir/99_TRANSCRIPT.md"
      fi
    else
      echo "FAIL: brainstorm runner failed session_id=$session_id"
      exit 1
    fi
  fi
}

is_running() {
  if [[ -f "$PIDFILE" ]]; then
    local pid
    pid=$(cat "$PIDFILE")
    if [[ -n "$pid" ]] && kill -0 "$pid" 2>/dev/null; then
      return 0
    fi
  fi
  return 1
}

start_daemon() {
  ensure_workflow
  if is_running; then
    echo "already running"
    exit 0
  fi
  if [[ $SELFTEST -eq 1 ]]; then
    bash "$WF/selftest.sh" --mode infra --wait 900
  else
    echo "NOTE: selftest skipped. Run 'club selftest' to verify infra."
  fi
  nohup "$WF/daemon.sh" >/dev/null 2>&1 &
  local pid=$!
  echo "$pid" > "$PIDFILE"
  echo "[daemon] start project=$ROOT pid=$pid" >> "$LOG"
  echo "started pid=$pid"
  echo "log: $LOG"
}

stop_daemon() {
  ensure_workflow
  if [[ ! -f "$PIDFILE" ]]; then
    echo "not running"
    exit 0
  fi
  local pid
  pid=$(cat "$PIDFILE")
  if [[ -z "$pid" ]]; then
    echo "not running"
    rm -f "$PIDFILE"
    exit 0
  fi
  if kill -0 "$pid" 2>/dev/null; then
    kill "$pid" 2>/dev/null || true
    for _ in {1..10}; do
      if ! kill -0 "$pid" 2>/dev/null; then
        break
      fi
      sleep 0.5
    done
  fi
  if kill -0 "$pid" 2>/dev/null; then
    echo "FAIL: process still running pid=$pid"
    exit 1
  fi
  rm -f "$PIDFILE"
  echo "stopped pid=$pid"
}

status_daemon() {
  ensure_workflow
  if is_running; then
    local pid
    pid=$(cat "$PIDFILE")
    local last
    last=$(tail -n 1 "$LOG" 2>/dev/null || echo "")
    echo "running pid=$pid root=$ROOT"
    echo "last_log=${last}"
    return 0
  fi
  echo "not running root=$ROOT"
}

logs_daemon() {
  ensure_workflow
  if [[ "${1:-}" == "--follow" ]]; then
    tail -n 200 -f "$LOG"
  else
    tail -n 200 "$LOG"
  fi
}

case "${1:-}" in
  start)
    shift
    if [[ "${1:-}" == "1" ]]; then
      SELFTEST=1
      shift
    fi
    require_tools
    start_daemon
    ;;
  stop)
    stop_daemon
    ;;
  status)
    status_daemon
    ;;
  logs)
    shift
    logs_daemon "${1:-}"
    ;;
  selftest)
    ensure_workflow
    bash "$WF/selftest.sh" --mode infra --wait 900
    ;;
  ask)
    shift
    ask_request "${*:-}"
    ;;
  brainstorm)
    shift
    brainstorm_request "$@"
    ;;
  --help|-h|help|"")
    usage
    ;;
  *)
    usage
    exit 1
    ;;
  esac

